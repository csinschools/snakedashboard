<!DOCTYPE html>
<html>
    <head>
        <title>Snake Game Dashboard</title>
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-QE9R7FHTTH"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'G-QE9R7FHTTH');
        </script>  
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-192691751-4"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-192691751-4');
        </script>
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-T56KV4L');</script>
        <!-- End Google Tag Manager -->

        <!-- external libs from cdnjs -->
        <script type="text/javascript" src="libs/jquery.min.js"></script>
        <script type="text/javascript" src="libs/jquery-ui.min.js"></script>
        <script type="text/javascript" src="libs/papaparse.min.js"></script>
        <script src="libs/plotly-basic-latest.min.js"></script>        

        <!-- PivotTable.js libs from ../dist -->
        <link rel="stylesheet" type="text/css" href="libs/pivot.css">
        <script type="text/javascript" src="libs//pivot.js"></script>
        <script type="text/javascript" src="libs//plotly_renderers.js"></script>        
        <style>
            body {font-family: Verdana;}
            body {
                font-family: Verdana;
                margin: 20px;
                width: 1024px;

                padding: 0 100px;
            }
            .session-container {
                margin-bottom: 20px;
            }
            .session-container label {
                margin-right: 10px;
            }
            .session-container input[type="text"] {
                padding: 5px;
                margin-right: 10px;
            }
            .session-container button {
                padding: 5px 10px;
                cursor: pointer;
            }
            .editor-link {
                display: block;
                margin-top: 10px;
            }            
            .button-container {
                display: flex;
                justify-content: left;
            }
            #reloadButton {
                width: 200px;
                height: 60px;
                background-color: greenyellow;
                font-size: larger;
            }
            .outputs-container {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(2, 1fr);
                gap: 20px;
                margin: 30px 0;
                width: 100%;
            }
            .outputs-container > div {
                min-height: 300px;
                border: 1px solid #ccc;
                padding: 10px;
                box-sizing: border-box;
                width: 100%;
                position: relative;
            }
            
            /* Loading spinner styles */
            .loading-spinner {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 1000;
                background: rgba(255, 255, 255, 0.9);
                padding: 20px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }
            
            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #3498db;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 10px;
            }
            
            .loading-text {
                text-align: center;
                color: #666;
                font-size: 14px;
            }
            
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>

        <!-- optional: mobile support with jqueryui-touch-punch -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

    </head>
    <body>
        <p style="width: 800px"></p>
        <div class="session-container">
            <label for="sessionId">Session ID:</label>
            <input type="text" id="sessionId" value="KIUP2Q8I">
            <button id="generateBtn">Generate new session id</button>
            <p>
                Game Link: <a id="editorLink" class="editor-link" href="https://csinschools.io/editor/editor.html?project=demos/snakeScoredCompiled.js&compiled=1&session=KIUP2Q8I" target="_blank">https://csinschools.io/editor/editor.html?project=demos/snakeScoredCompiled.js&compiled=1&session=KIUP2Q8I</a>
            </p>
            
        </div>        

        <div class="button-container">
            <button id="reloadButton">Refresh Data</button>    
        </div>

        <div class="outputs-container">
            <div id="output1">
                <div class="loading-spinner" id="spinner1">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading data...</div>
                </div>
            </div>
            <div id="output2">
                <div class="loading-spinner" id="spinner2">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading data...</div>
                </div>
            </div>
            <div id="output3">
                <div class="loading-spinner" id="spinner3">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading data...</div>
                </div>
            </div>
            <div id="output4">
                <div class="loading-spinner" id="spinner4">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading data...</div>
                </div>
            </div>
        </div>
        
        <script type="text/javascript">
            // This example loads the "Canadian Parliament 2012"
            // dataset from a CSV instead of from JSON.
            function loadPivotTable() {        
                var derivers = $.pivotUtilities.derivers;
                var renderers = $.extend($.pivotUtilities.renderers,
                    $.pivotUtilities.plotly_renderers);     
                    
                const sessionId = $('#sessionId').val();
                const baseUrl = 'https://codestore-348206.ts.r.appspot.com/datalogging/readlogcsv/?school=school_logging&session=';
        
                // Show loading spinners
                $('#spinner1, #spinner2, #spinner3, #spinner4').show();
        
                Papa.parse(baseUrl + sessionId, {
                    download: true,
                    skipEmptyLines: true,
                    complete: function(parsed){

                        $('#output1, #output2, #output3, #output4').empty();
                        if (parsed.data.length === 0) {
                            // Hide spinners if no data
                            $('#spinner1, #spinner2, #spinner3, #spinner4').hide();
                            return;
                        }

                        // Re-add spinners after clearing containers
                        $('#output1').html('<div class="loading-spinner" id="spinner1"><div class="spinner"></div><div class="loading-text">Processing data...</div></div>');
                        $('#output2').html('<div class="loading-spinner" id="spinner2"><div class="spinner"></div><div class="loading-text">Processing data...</div></div>');
                        $('#output3').html('<div class="loading-spinner" id="spinner3"><div class="spinner"></div><div class="loading-text">Processing data...</div></div>');
                        $('#output4').html('<div class="loading-spinner" id="spinner4"><div class="spinner"></div><div class="loading-text">Processing data...</div></div>');


                        let columnnames = ['Date','Player','Score','Moves','Snake Length'];
                        const data = parsed.data.map((row, index) => {
                            const obj = {};
                            row.forEach((value, colIndex) => {
                                obj[columnnames[colIndex]] = value;
                            });
                            return obj;
                        });

                        $("#output1").pivotUI(data, {
                            showUI: false,
                            renderers: renderers,
                            rendererName: "Bar Chart",
                            rendererOptions: {
                                plotly: {
                                    width: 600,
                                    height: 480,
                                    title: "Highest Score by Player",
                                    yaxis: { title: "Highest Score" }

                                }
                            },
                            rows: ["Player"], 
                            vals: ["Score"],
                            aggregatorName: "Maximum",
                            colOrder: "value_z_to_a",
                            onRefresh: function() {
                                $('#spinner1').hide();
                            }
                        });
                        $("#output2").pivotUI(data, {
                            showUI: false,
                            renderers: renderers,
                            rendererName: "Horizontal Bar Chart",
                            rendererOptions: { 
                                plotly: {   
                                    colorway: ['yellow'],
                                    width: 600, 
                                    height: 480,
                                    title: "Longest Snake by Player",
                                    xaxis: { title: "Longest Snake Length" }
                                }
                            },              
                            rows: ["Player"], 
                            vals: ["Snake Length"],
                            aggregatorName: "Maximum",
                            colOrder: "value_z_to_a",
                            onRefresh: function() {
                                $('#spinner2').hide();
                            }
                        });         
                        $("#output3").pivotUI(data, {
                            showUI: false,
                            renderers: renderers,
                            rendererName: "Horizontal Bar Chart",
                            rendererOptions: {
                                plotly: {
                                    colorway: ['green'],
                                    width: 600,
                                    height: 480,
                                    title: "Most Moves in a Game by Player",
                                    xaxis: { title: "Most Moves in a Game" }
                                }
                            },
                            rows: ["Player"], 
                            vals: ["Moves"],
                            aggregatorName: "Maximum",
                            colOrder: "value_z_to_a",
                            onRefresh: function() {
                                $('#spinner3').hide();
                            }
                        });
                        $("#output4").pivotUI(data, {
                            showUI: false,
                            renderers: renderers,
                            rendererName: "Bar Chart",
                            rendererOptions: { 
                                plotly: {   
                                    width: 600, 
                                    height: 480,
                                    title: "Total Games Played by Player",
                                    yaxis: { title: "Total Games Played" }
                                }
                            },              
                            rows: ["Player"], 
                            colOrder: "value_z_to_a",
                            onRefresh: function() {
                                $('#spinner4').hide();
                            }
                        });                                                                                        
                    }
                });
            }
        
            $(function(){

                // Function to generate a random session ID
                function generateSessionId() {
                    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                    let result = '';
                    for (let i = 0; i < 8; i++) {
                        result += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    return result;
                }

                // Update the editor link when session ID changes
                function updateEditorLink() {
                    const sessionId = $('#sessionId').val();
                    const baseUrl = 'https://csinschools.io/editor/editor.html?project=demos/snakeScoredCompiled.js&compiled=1&session=';
                    $('#editorLink').attr('href', baseUrl + sessionId);
                    $('#editorLink').html(baseUrl + sessionId);
                }

                // Handle generate button click
                $('#generateBtn').click(function() {
                    $('#sessionId').val(generateSessionId());
                    updateEditorLink();
                });

                // Update link when session ID is manually changed
                $('#sessionId').on('input', updateEditorLink);                

                // Initialize session ID from URL parameter or default
                const urlSessionId = getUrlParameter('session');
                if (urlSessionId) {
                    $('#sessionId').val(urlSessionId);
                }
                updateEditorLink();
                loadPivotTable();
             });
        
            // Add a button to reload
            $("#reloadButton").click(function() {
                loadPivotTable();
            });     

            function getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                var results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            }
        </script>
        
    </body>
</html>
